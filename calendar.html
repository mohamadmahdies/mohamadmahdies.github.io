<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ØªÙ‚ÙˆÛŒÙ… Ù‡Ø¯Ø§ÛŒØ§ | Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
      crossorigin="anonymous"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #fff8f7;
        --card: #ffffff;
        --accent: #ea5458;
        --accent-2: #c63e42;
        --accent-light: #fde8e9;
        --text: #1f1a1b;
        --muted: #6b5f60;
        --border: #f0d7d8;
        --shadow: 0 24px 70px rgba(234, 84, 88, 0.12);
        font-family: "Vazirmatn", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(150deg, #fff8f7 0%, #fde8e9 45%, #fff8f7 100%);
        color: var(--text);
        line-height: 1.7;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px clamp(20px, 4vw, 56px) 64px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .page-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 16px;
        align-items: center;
      }

      .page-title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .page-title h1 {
        margin: 0;
        font-size: clamp(26px, 4vw, 34px);
        color: var(--accent);
      }

      .page-title span {
        color: var(--muted);
        font-size: 14px;
      }

      .back-link {
        text-decoration: none;
        padding: 10px 18px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid var(--border);
        color: var(--accent);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(280px, 360px) 1fr;
        gap: 20px;
        align-items: flex-start;
      }

      .card {
        background: var(--card);
        border-radius: 24px;
        padding: 20px clamp(18px, 3vw, 28px);
        box-shadow: 0 18px 45px rgba(234, 84, 88, 0.12);
        border: 1px solid rgba(234, 84, 88, 0.08);
      }

      .card h2 {
        margin: 0 0 8px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card p {
        margin: 0 0 16px;
        color: var(--muted);
        font-size: 14px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: var(--accent-light);
        color: var(--accent);
        font-size: 13px;
        font-weight: 600;
      }

      form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        font-weight: 600;
        color: #27314f;
      }

      input,
      select,
      textarea {
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 12px 14px;
        font-family: inherit;
        font-size: 14px;
        background: #fbfbff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input:not([type="checkbox"]),
      select {
        height: 52px;
      }

      select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #c63e42 50%),
          linear-gradient(135deg, #c63e42 50%, transparent 50%);
        background-position: 16px 52%, 24px 52%;
        background-size: 9px 9px, 9px 9px;
        background-repeat: no-repeat;
        padding-inline-start: 42px; /* space for arrow on the left (RTL) */
        padding-inline-end: 14px;
        text-align: right;
        text-align-last: right;
      }

      textarea {
        resize: vertical;
        min-height: 110px;
        height: auto;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(234, 84, 88, 0.14);
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      .form-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-top: 4px;
        flex-wrap: wrap;
      }

      .form-actions .btn {
        justify-content: center;
        min-width: 160px;
      }

      .form-actions .toggle-group {
        flex: 1;
        justify-content: flex-end;
      }

      .btn {
        border-radius: 999px;
        border: none;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff;
        box-shadow: 0 10px 30px rgba(234, 84, 88, 0.25);
      }

      .btn-ghost {
        background: #fff7f7;
        border: 1px solid var(--border);
        color: var(--muted);
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .toggle-group {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--muted);
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff7f7;
        font-weight: 600;
        white-space: nowrap;
      }

      .toggle-group input {
        width: 16px;
        height: 16px;
        accent-color: var(--accent);
      }

      .lists-column {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .section-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .section-header span {
        font-size: 13px;
        color: var(--muted);
      }

      .upcoming-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .upcoming-empty,
      .all-empty {
        text-align: center;
        padding: 18px;
        border-radius: 18px;
        border: 1px dashed var(--border);
        color: var(--muted);
        font-size: 14px;
      }

      .upcoming-card {
        background: linear-gradient(135deg, #ffffff, #ffeef0);
        border-radius: 18px;
        padding: 14px 16px;
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 10px;
        align-items: center;
        border: 1px solid rgba(234, 84, 88, 0.15);
      }

      .up-top {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .up-title {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }

      .up-type {
        font-size: 13px;
        color: var(--muted);
      }

      .up-description {
        font-size: 13px;
        color: var(--muted);
      }

      .up-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        font-size: 13px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid var(--border);
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }

      .pill-accent {
        background: var(--accent-light);
        border-color: transparent;
        color: var(--accent);
      }

      .all-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }

      .event-card {
        background: #fffafa;
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 14px 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
      }

      .event-card h3 {
        margin: 0;
        font-size: 15px;
      }

      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 2px;
      }

      .event-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px;
        gap: 8px;
      }

      .event-footer button {
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 999px;
      }

      .event-footer .btn-danger {
        background: #ffe6e6;
        border: 1px solid #ffc2c2;
        color: #d7263d;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (max-width: 900px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 720px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .form-actions .toggle-group {
          width: 100%;
          justify-content: center;
          text-align: center;
        }

        .form-actions .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header class="page-header">
        <div class="page-title">
          <h1 id="calendarTitle">ØªÙ‚ÙˆÛŒÙ… Ù‡Ø¯Ø§ÛŒØ§</h1>
          <span id="calendarSubtitle">Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù‡Ù… Ø®ÙˆØ¯Øª Ùˆ Ø¯ÙˆØ³ØªØ§Ù†Øª Ø±Ø§ ÛŒÚ©â€ŒØ¬Ø§ Ø¨Ø¨ÛŒÙ†.</span>
        </div>
        <a href="./index.html" class="back-link">
          <span>â†</span>
          <span>Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©ØªØ§Ø¨Ú†Ù‡ Ù‡Ø¯ÛŒÙ‡</span>
        </a>
      </header>

      <section class="layout">
        <section class="card">
          <div class="badge">Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</div>
          <h2>Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§</h2>
          <p>
            Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒÛŒ Ù…Ø«Ù„ ØªÙˆÙ„Ø¯ØŒ Ø³Ø§Ù„Ú¯Ø±Ø¯ØŒ Ø±ÙˆØ² Ù…Ø§Ø¯Ø± ÛŒØ§ Ù‡Ø± Ù…Ù†Ø§Ø³Ø¨Øª Ø´Ø®ØµÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø«Ø¨Øª Ú©Ù†
            ØªØ§ Ø¨Ø±Ø§ÛŒØ´ Ø²ÙˆØ¯ØªØ± Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÛŒ Ù‡Ø¯ÛŒÙ‡â€ŒØ¯Ø§Ø¯Ù† Ø¨Ú†ÛŒÙ†ÛŒ.
          </p>

          <form id="eventForm">
            <div class="form-row">
              <label>
                Ø¹Ù†ÙˆØ§Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯
                <input
                  type="text"
                  name="title"
                  required
                  placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÙˆÙ„Ø¯ Ø¨Ø§Ù‚Ø±"
                />
              </label>
              <label>
                Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯
                <select name="type">
                  <option value="birthday">ØªÙˆÙ„Ø¯</option>
                  <option value="anniversary">Ø³Ø§Ù„Ú¯Ø±Ø¯ Ø§Ø²Ø¯ÙˆØ§Ø¬</option>
                  <option value="mother">Ø±ÙˆØ² Ù…Ø§Ø¯Ø±</option>
                  <option value="father">Ø±ÙˆØ² Ù¾Ø¯Ø±</option>
                  <option value="custom">Ø³Ø§ÛŒØ±</option>
                </select>
              </label>
            </div>

            <div class="form-row">
              <label>
                ØªØ§Ø±ÛŒØ®
                <input type="date" name="date" required />
              </label>
              <label>
                Ø¨Ø±Ø§ÛŒ Ú†Ù‡ Ú©Ø³ÛŒ Ø§Ø³ØªØŸ
                <select name="scope">
                  <option value="self">Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù…</option>
                  <option value="friend">Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø¯ÙˆØ³Øª/Ø¹Ø¶Ùˆ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</option>
                </select>
              </label>
            </div>

            <label id="friendNameWrapper">
              Ù†Ø§Ù… Ø¯ÙˆØ³Øª / Ù†Ø³Ø¨Øª (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø§Ø¯Ø±ØŒ Ù‡Ù…Ø³Ø±ØŒ ÛŒØ³Ù†Ø§)
              <input
                type="text"
                name="friendName"
                placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø§Ø¯Ø±"
              />
            </label>

            <label>
              ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
              <textarea
                name="description"
                placeholder="Ú†ÛŒØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ø¯ØŒ Ø§ÛŒØ¯Ù‡â€ŒÛŒ Ù‡Ø¯ÛŒÙ‡ØŒ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒÛŒ Ø­Ø¯ÙˆØ¯ÛŒ Ùˆ ..."
              ></textarea>
            </label>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯
              </button>
              <button type="button" id="clearAll" class="btn btn-ghost">
                Ø­Ø°Ù Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† ØªÙ‚ÙˆÛŒÙ…
              </button>
              <label class="toggle-group">
                <input type="checkbox" id="showFriendsToggle" checked />
                <span>Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù†</span>
              </label>
            </div>
          </form>
        </section>

        <section class="lists-column">
          <section class="card">
            <div class="section-header">
              <div>
                <h2>Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙ Ø±Ùˆ (Û³Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡)</h2>
                <span id="upcomingSummary">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</span>
              </div>
              <div class="legend">
                <span class="pill pill-accent">Ø®ÙˆØ¯Øª</span>
                <span class="pill">Ø¯ÙˆØ³ØªØ§Ù†</span>
              </div>
            </div>
            <div id="upcomingList" class="upcoming-list"></div>
          </section>

          <section class="card">
            <div class="section-header">
              <div>
                <h2>Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h2>
                <span id="allSummary">Û° Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
              </div>
            </div>
            <div id="allEvents" class="all-grid"></div>
          </section>
        </section>
      </section>
    </main>

    <script>
      //=== Helper: person from URL (Ù…Ø´Ø§Ø¨Ù‡ index.html) ===
      function getPersonParam() {
        const params = new URLSearchParams(window.location.search);
        return params.get("person") || "default";
      }

      function getStorageKey() {
        const personParam = getPersonParam();
        return `giftCalendarEvents_${personParam}`;
      }

      function readEvents() {
        try {
          const raw = localStorage.getItem(getStorageKey());
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          return [];
        }
      }

      function writeEvents(events) {
        localStorage.setItem(getStorageKey(), JSON.stringify(events || []));
      }

      function createId() {
        return "ev_" + Date.now() + "_" + Math.random().toString(36).slice(2, 9);
      }

      function normalizeDateToThisYear(dateStr) {
        // Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡ØŒ Ø³Ø§Ù„ Ø±Ø§ Ø±ÙˆÛŒ Ø§Ù…Ø³Ø§Ù„ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
        if (!dateStr) return null;
        const [y, m, d] = dateStr.split("-").map(Number);
        if (!y || !m || !d) return null;
        const now = new Date();
        const target = new Date(now.getFullYear(), m - 1, d);
        // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø§Ù…Ø³Ø§Ù„ Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø§Ù„ Ø¨Ø¹Ø¯ Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
        if (target < startOfDay(now)) {
          target.setFullYear(now.getFullYear() + 1);
        }
        return target;
      }

      function startOfDay(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        return d;
      }

      function diffInDays(a, b) {
        const ms = startOfDay(a) - startOfDay(b);
        return Math.round(ms / (1000 * 60 * 60 * 24));
      }

      function formatDate(dateStr) {
        if (!dateStr) return "Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®";
        try {
          const d = new Date(dateStr);
          if (Number.isNaN(d.getTime())) return dateStr;
          return d.toLocaleDateString("fa-IR", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        } catch {
          return dateStr;
        }
      }

      function typeLabel(type) {
        switch (type) {
          case "birthday":
            return "ØªÙˆÙ„Ø¯";
          case "anniversary":
            return "Ø³Ø§Ù„Ú¯Ø±Ø¯ Ø§Ø²Ø¯ÙˆØ§Ø¬";
          case "mother":
            return "Ø±ÙˆØ² Ù…Ø§Ø¯Ø±";
          case "father":
            return "Ø±ÙˆØ² Ù¾Ø¯Ø±";
          default:
            return "Ø±ÙˆÛŒØ¯Ø§Ø¯";
        }
      }

      //=== Rendering ===
      const eventForm = document.getElementById("eventForm");
      const clearAllBtn = document.getElementById("clearAll");
      const showFriendsToggle = document.getElementById("showFriendsToggle");
      const friendNameWrapper = document.getElementById("friendNameWrapper");
      const upcomingListEl = document.getElementById("upcomingList");
      const upcomingSummaryEl = document.getElementById("upcomingSummary");
      const allEventsEl = document.getElementById("allEvents");
      const allSummaryEl = document.getElementById("allSummary");
      const calendarTitle = document.getElementById("calendarTitle");
      const calendarSubtitle = document.getElementById("calendarSubtitle");

      function bootstrapTitle() {
        // Ø§Ú¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ ÙˆØµÙ„ Ø´Ø¯ Ø¨Ù‡ people-configØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø§Ø³Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒÙ…
        const person = getPersonParam();
        if (person && person !== "default") {
          calendarTitle.textContent = `ØªÙ‚ÙˆÛŒÙ… Ù…Ù†`;
          calendarSubtitle.textContent =
            "Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ùˆ Ø¯ÙˆØ³ØªØ§Ù†Ø´) Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†.";
        }
      }

      function render(events) {
        const showFriends = showFriendsToggle.checked;
        const now = new Date();
        const today = startOfDay(now);

        const filtered = events.filter((ev) =>
          showFriends ? true : !ev.isFriend
        );

        // Sort by next occurrence within a year
        const withNextDate = filtered.map((ev) => {
          const nextDate = normalizeDateToThisYear(ev.date);
          return { ...ev, _nextDate: nextDate };
        });

        withNextDate.sort((a, b) => {
          if (!a._nextDate || !b._nextDate) return 0;
          return a._nextDate - b._nextDate;
        });

        // Upcoming 30 days
        const upcoming = withNextDate.filter((ev) => {
          if (!ev._nextDate) return false;
          const diff = diffInDays(ev._nextDate, today);
          return diff >= 0 && diff <= 30;
        });

        // Render upcoming
        upcomingListEl.innerHTML = "";
        if (!upcoming.length) {
          upcomingListEl.innerHTML =
            '<div class="upcoming-empty">Ø¯Ø± Û³Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
        } else {
          upcoming.forEach((ev) => {
            const daysLeft = diffInDays(ev._nextDate, today);
            const daysLabel =
              daysLeft === 0
                ? "Ø§Ù…Ø±ÙˆØ²"
                : daysLeft === 1
                ? "Û± Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡"
                : `${daysLeft.toLocaleString("fa-IR")} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡`;

            const ownerPill = ev.isFriend
              ? `<span class="pill">Ø¯ÙˆØ³Øª: ${ev.friendName || "â€”"}</span>`
              : `<span class="pill pill-accent">Ø®ÙˆØ¯Øª</span>`;

            const html = `
              <article class="upcoming-card">
                <div class="up-top">
                  <div class="up-title">
                    <span>ğŸ‰</span>
                    <span>${ev.title}</span>
                  </div>
                  <div class="up-type">${typeLabel(ev.type)} â€¢ ${formatDate(
                    ev.date
                  )}</div>
                  ${
                    ev.description
                      ? `<div class="up-description">${ev.description}</div>`
                      : ""
                  }
                </div>
                <div class="up-meta">
                  <span class="pill">${daysLabel}</span>
                  ${ownerPill}
                </div>
              </article>
            `;
            const wrapper = document.createElement("div");
            wrapper.innerHTML = html.trim();
            upcomingListEl.appendChild(wrapper.firstElementChild);
          });
        }

        // Upcoming summary
        const selfCount = upcoming.filter((ev) => !ev.isFriend).length;
        const friendCount = upcoming.filter((ev) => ev.isFriend).length;
        upcomingSummaryEl.textContent = `Ø¯Ø± Û³Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ ${
          (selfCount + friendCount).toLocaleString("fa-IR") || "Û°"
        } Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø§Ø±ÛŒ (${selfCount.toLocaleString(
          "fa-IR"
        )} Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯ØªØŒ ${friendCount.toLocaleString("fa-IR")} Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù†).`;

        // Render all events
        allEventsEl.innerHTML = "";
        if (!filtered.length) {
          allEventsEl.innerHTML =
            '<div class="all-empty">Ù‡Ù†ÙˆØ² Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† ØªÙ‚ÙˆÛŒÙ… Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
        } else {
          filtered.forEach((ev) => {
            const nextDate = ev._nextDate;
            const daysLeft =
              nextDate != null ? diffInDays(nextDate, today) : null;
            const daysLabel =
              daysLeft == null
                ? ""
                : daysLeft === 0
                ? "Ø§Ù…Ø±ÙˆØ²"
                : daysLeft > 0
                ? `${daysLeft.toLocaleString("fa-IR")} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡`
                : `${Math.abs(daysLeft).toLocaleString("fa-IR")} Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡`;

            const ownerPill = ev.isFriend
              ? `<span class="pill">Ø¯ÙˆØ³Øª: ${ev.friendName || "â€”"}</span>`
              : `<span class="pill pill-accent">Ø®ÙˆØ¯Øª</span>`;

            const html = `
              <article class="event-card" data-id="${ev.id}">
                <h3>${ev.title}</h3>
                <div class="event-meta">
                  <span class="pill">${typeLabel(ev.type)}</span>
                  <span class="pill">${formatDate(ev.date)}</span>
                  ${ownerPill}
                  ${
                    daysLabel
                      ? `<span class="pill">${daysLabel}</span>`
                      : ""
                  }
                </div>
                ${
                  ev.description
                    ? `<div class="muted">${ev.description}</div>`
                    : ""
                }
                <div class="event-footer">
                  <span class="muted">${
                    ev.isFriend
                      ? "Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯ÙˆØ³Øª / Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡"
                      : "Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´Ø®ØµÛŒ"
                  }</span>
                  <button class="btn btn-danger" data-delete="${
                    ev.id
                  }">Ø­Ø°Ù</button>
                </div>
              </article>
            `;
            const wrapper = document.createElement("div");
            wrapper.innerHTML = html.trim();
            allEventsEl.appendChild(wrapper.firstElementChild);
          });
        }

        allSummaryEl.textContent = `${filtered.length.toLocaleString(
          "fa-IR"
        )} Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡`;
      }

      //=== Event handlers ===
      eventForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(eventForm);
        const title = (formData.get("title") || "").toString().trim();
        const type = (formData.get("type") || "custom").toString();
        const date = (formData.get("date") || "").toString();
        const scope = (formData.get("scope") || "self").toString();
        const friendName = (formData.get("friendName") || "").toString().trim();
        const description = (formData.get("description") || "").toString().trim();

        if (!title || !date) {
          alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ ØªØ§Ø±ÛŒØ® Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
          return;
        }

        const events = readEvents();
        events.push({
          id: createId(),
          title,
          type,
          date,
          isFriend: scope === "friend",
          friendName: scope === "friend" ? friendName : "",
          description,
          createdAt: new Date().toISOString(),
        });
        writeEvents(events);
        eventForm.reset();
        render(events);
      });

      clearAllBtn.addEventListener("click", () => {
        if (
          !confirm(
            "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† ØªÙ‚ÙˆÛŒÙ… Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØŸ Ø§ÛŒÙ† Ú©Ø§Ø± Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª."
          )
        ) {
          return;
        }
        writeEvents([]);
        render([]);
      });

      showFriendsToggle.addEventListener("change", () => {
        render(readEvents());
      });

      // Delete single event
      allEventsEl.addEventListener("click", (e) => {
        const btn = e.target;
        const id = btn.getAttribute("data-delete");
        if (!id) return;
        const events = readEvents();
        const next = events.filter((ev) => ev.id !== id);
        writeEvents(next);
        render(next);
      });

      // Scope change => toggle friend field
      eventForm.elements["scope"].addEventListener("change", (e) => {
        const val = e.target.value;
        if (val === "friend") {
          friendNameWrapper.style.display = "flex";
        } else {
          friendNameWrapper.style.display = "none";
        }
      });

      // Init
      (function init() {
        bootstrapTitle();
        const events = readEvents();
        render(events);
        // default: hide friend name field until needed
        const scope = eventForm.elements["scope"].value;
        if (scope !== "friend") {
          friendNameWrapper.style.display = "none";
        }
      })();
    </script>
  </body>
</html>


